#!/usr/bin/env node
/**
 * Reads Hardhat Ignition's deployed_addresses.json and writes
 * frontend/src/contracts/addresses.js so the app uses the latest deployed contracts.
 *
 * Run after: npx hardhat ignition deploy ignition/modules/ArkenDeploy.js --network localhost
 *
 * Usage:
 *   node scripts/update-frontend-addresses.js
 *   node scripts/update-frontend-addresses.js 31337
 *   CHAIN_ID=31337 node scripts/update-frontend-addresses.js
 */

const fs = require("fs");
const path = require("path");

const chainId = process.env.CHAIN_ID || process.argv[2] || "31337";
const deploymentsDir = path.join(__dirname, "..", "ignition", "deployments", `chain-${chainId}`);
const addressesPath = path.join(deploymentsDir, "deployed_addresses.json");
const outputPath = path.join(__dirname, "..", "frontend", "src", "contracts", "addresses.js");

if (!fs.existsSync(addressesPath)) {
  console.error(`No deployment found at ${addressesPath}`);
  console.error("Deploy first: npx hardhat ignition deploy ignition/modules/ArkenDeploy.js --network localhost");
  process.exit(1);
}

const data = JSON.parse(fs.readFileSync(addressesPath, "utf8"));
const staking = data["ArkenDeploy#ArkenstoneStaking"];
const token = data["ArkenDeploy#ArkenstoneToken"];

if (!staking || !token) {
  console.error("deployed_addresses.json missing ArkenDeploy#ArkenstoneStaking or ArkenDeploy#ArkenstoneToken");
  process.exit(1);
}

const content = `// Auto-generated by scripts/update-frontend-addresses.js â€” do not edit by hand
// Source: ignition/deployments/chain-${chainId}/deployed_addresses.json

export const STAKING_ADDRESS = "${staking}";
export const TOKEN_ADDRESS   = "${token}";

export const HARDHAT_CHAIN_ID = ${chainId};
`;

fs.writeFileSync(outputPath, content, "utf8");
console.log("Updated frontend/src/contracts/addresses.js");
console.log("  STAKING_ADDRESS:", staking);
console.log("  TOKEN_ADDRESS:  ", token);
